<!DOCTYPE html>
<html lang="en">
<head>
	<title>Battleship</title>
	<style type="text/css" media="screen">
		.split {
			min-width: 50%;
			height: 100vh; 
			float: left;
		}

		body {
			width: 100%;
			height: 100vh;
		}

		/* ACE Editor*/
	    #editor { 
	        min-width: 50%;
	        min-height: 50%;
	    }

	    #send_button, #save_button {
	    	min-width: 49.7%;
	    	min-height: 5%;
	    }

	    /* Grid */
	    #your_grid {
	    	/*background-color: #337ab7; */
	    	background-color: #5bc0de;
	    }

	    #computer_grid {

	    }

	    #computer_grid .btn-group, #your_grid .btn-group {
	    	width: 100%;
	    }

	    #computer_grid button, #your_grid button{
	    	width: 20%;
	    	height: 16.71vh;
	    }

	    .fixed-table-body {
	    	height: 49.9vh !important;
	    }

	    #controls {
	    	background-color: #245580;
	    }
	</style>	
	
	<!-- API -->
	<script src="js/api.js" type="text/javascript" charset="utf-8"></script>

	<!--ACE Editor-->
	<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="ace-builds/src/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>

	<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>	
	<!--Bootstrap Table-->
	<script src="https://rawgit.com/wenzhixin/bootstrap-table/master/dist/bootstrap-table.min.js"></script>	
	<link rel="stylesheet" href="https://rawgit.com/wenzhixin/bootstrap-table/master/dist/bootstrap-table.min.css">

	<!--Bootstrap-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
	<!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>-->
</head>
<body>
	<div class="split">
		<div id="editor" onkeypress="editorKeyPressed()"></div>
		<script>
		    editor = ace.edit("editor");
		    editor.setTheme("ace/theme/monokai");
		    editor.getSession().setMode("ace/mode/javascript");
		    editor.setOptions({
        		enableBasicAutocompletion: true,
        		enableSnippets: true,
        		enableLiveAutocompletion: false
    		});
		</script>
		<div id="controls">
			<button type="button" class="btn btn-primary" id="send_button" onclick="runButtonOnClicked()"><img src="glyphicons/png/glyphicons-422-send.png"></button>
			<button type="button" class="btn btn-primary" id="save_button" onclick="saveButtonOnClicked()"><img id="save_icon" src="glyphicons/png/glyphicons-447-floppy-save.png"></button>
		</div>
	</div>
	<div class="split" id="game">
		<div id="your_grid"></div>
		<div id="computer_grid">
			<table id="table" style="max-height: 50%">
    			<thead>
        			<tr>
		            	<th data-field="id">Ship ID</th>
		            	<th data-field="name_of_ship">Name of Ship</th>
		            	<th data-field="owner">Owner</th>
        			</tr>
    			</thead>
			</table>
		</div>
	</div>
	<script type="text/javascript">
		/*
		 *	Load the ships
		 */		
		$.ajax({
			    type: "POST",
			    url: "/query",			    
			    data: JSON.stringify({ "query": "SELECT * FROM ships" }),
			    contentType: "application/json; charset=utf-8",
			    dataType: "json",
			    success: function(data){
			    	$('#table').bootstrapTable({
        				data: data.rows,
        				classes:'table table-hover',
        				striped: true,
    				});
			    },
			    failure: function(errMsg) {
			        console.log(errMsg);
			    }
			});
	</script>
	<script type="text/javascript">
		/**
		 * [When editor detectes a keystoke]
		 */
		function editorKeyPressed(){
			document.getElementById("save_icon").src = "glyphicons/png/glyphicons-447-floppy-save.png";
			document.getElementById("save_button").className ="btn btn-primary";
		}

		/**
		 * [Run Button ActionListner]
		 */
		function runButtonOnClicked(){
			runCode(editor.getValue());
		}

		/**
		 * [Save Button ActionListner]
		 */
		function saveButtonOnClicked(){
			document.getElementById("save_icon").src = "glyphicons/png/glyphicons-445-floppy-saved.png";
			document.getElementById("save_button").className ="btn btn-success";

			/* Modify the code */
			var code = editor.getValue();
			for (var i = 0; i < code.length; i++) {
				var char = code.charAt(i);
				if(char === "\""){
					code = "\'" + editor.getValue() + "\'";
					break;
				} else if(char === "\'") {
					code = "\"" + editor.getValue() + "\"";
					break;
				} else {
					continue;
				}
			}
			var request = "INSERT INTO code (code) VALUES (" + code + ")";
			console.log("code" + code);

			/* Send the request */
			$.ajax({
				type: "POST",
			    url: "/save/code",			    
			    data: JSON.stringify({ "code": request }),
			    contentType: "application/json; charset=utf-8",
			    dataType: "json",
			    success: function(data){
			    	console.log(data);
			    },
			    failure: function(errMsg) {
			    	console.log(errMsg);
			    }
			});
		}

		/**
		 * [Sends a given query to the server via AJAX]
		 * @param  {String} query [Query Instruction]
		 * @return {response}       [Returns the server response]
		 */
		function sendQuery(query){
			$.ajax({
				type: "POST",
			    url: "/query",			    
			    data: JSON.stringify({ "query": query }),
			    contentType: "application/json; charset=utf-8",
			    dataType: "json",
			    success: function(data){
			    	console.log("success");
			    	console.log("data: " + data);
			    	return data;
			    },
			    failure: function(errMsg) {
			    	console.log("error");
			        return errMsg;
			    }
			});
		}
		
		/**
		 * Grid JS
		 */

		/*
		How to append
		var mydiv = document.getElementById("buttons");
		var mycontent = document.createElement("p");
		mycontent.appendChild(document.createTextNode("This is a paragraph"));
		mydiv.appendChild(mycontent);*/

		/* First Loop with innerHTML */
		var rows = 3;
		var columns = 5
		var content = '';
		var square = '';
		var group = '<div class="btn-group btn-group-lg" role="group" aria-label="..." id="buttons">';

		for (var i = 0; i < rows; i++) {
			content += group;
			for (var j = 0; j < columns; j++) {
				square = i + "," + j;
				//content += '<button type="button" class="btn btn-primary" id="' + square + '"' + 'onclick="clicked(' + square + ')">'+ i + ',' + j + '</button>';
				content += '<button type="button" class="btn btn-info" id="' + square + '"' + 'onclick="clicked(' + square + ')">' + '<img src="glyphicons/png/glyphicons-256-boat.png">' + '</button>';
				//content += '<button type="button" class="btn btn-primary"' + 'onclick="clicked(' + square + ')">' + '</button>';
			}
			content += '</div></br>';
		}

		document.getElementById('your_grid').innerHTML = content;
		//document.getElementById('your_grid').innerHTML = content;

		function buildGrid(numrows, numcols, initial){
   			var arr = [];
   			for (var i = 0; i < numrows; ++i){
      			var columns = [];
      			for (var j = 0; j < numcols; ++j){
         			columns[j] = Math.floor((Math.random() * 2));
      			}
      			arr[i] = columns;
    		}
    		return arr;
		}

		var grid = buildGrid(rows, columns, 0);

		/**
		 * Call function when the user clicks on the grid
		 *
		 **/
		function clicked(row, column) {
			var square = row + ',' + column;
			console.log(grid[row][column]);

			if(grid[row][column] == 1){
				// isAShip
				document.getElementById(square).className = "btn btn-success";
				document.getElementById(square).innerHTML = "HIT!";
			} else {
				document.getElementById(square).className = "btn btn-danger";
				document.getElementById(square).innerHTML = '<span class="glyphicon glyphicon-remove"  aria-hidden="true"></span>';
			}
		}

		/*
		 * Load code from the database
		 */
		$.ajax({
		    type: "POST",
		    url: "/query",			    
		    data: JSON.stringify({ "query":  "SELECT * FROM code" }),
		    contentType: "application/json; charset=utf-8",
		    dataType: "json",
		    success: function(data){
		    	//console.log();
		    	editor.insert(data.rows[0].code);
		    },
		    failure: function(errMsg) {
		        console.log(errMsg);
		    }
		});
	</script>
</body>
</html>